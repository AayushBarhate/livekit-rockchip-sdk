name: Build LiveKit SDK with Rockchip MPP

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  LIVEKIT_SDK_COMMIT: "9e635aa6"
  RUST_VERSION: "stable"

jobs:
  build:
    name: Cross-compile for aarch64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone LiveKit rust-sdks at pinned commit
        run: |
          git clone https://github.com/livekit/rust-sdks.git /tmp/rust-sdks
          cd /tmp/rust-sdks
          git checkout ${{ env.LIVEKIT_SDK_COMMIT }}
          echo "LiveKit SDK checked out at $(git rev-parse --short HEAD)"

      - name: Apply Rockchip MPP patches
        run: |
          chmod +x ./apply_patches.sh
          ./apply_patches.sh /tmp/rust-sdks

      - name: Verify patches were applied
        run: |
          echo "--- build.rs diff ---"
          cd /tmp/rust-sdks
          git diff -- webrtc-sys/build.rs
          echo ""
          echo "--- video_encoder_factory.cpp diff ---"
          git diff -- webrtc-sys/src/video_encoder_factory.cpp
          echo ""
          echo "--- video_decoder_factory.cpp diff ---"
          git diff -- webrtc-sys/src/video_decoder_factory.cpp

      - name: Install aarch64 cross-compile toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            pkg-config \
            libssl-dev

      - name: Install Rust and aarch64 target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Setup pkg-config for cross compilation
        run: |
          # Create a pkg-config wrapper that points to the aarch64 sysroot
          sudo mkdir -p /usr/aarch64-linux-gnu/lib/pkgconfig
          cat > /tmp/aarch64-pkg-config <<'WRAPPER'
          #!/bin/sh
          export PKG_CONFIG_DIR=
          export PKG_CONFIG_LIBDIR=/usr/aarch64-linux-gnu/lib/pkgconfig:/usr/lib/aarch64-linux-gnu/pkgconfig
          export PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu
          exec pkg-config "$@"
          WRAPPER
          chmod +x /tmp/aarch64-pkg-config

      - name: Download pre-built libwebrtc.a
        id: webrtc
        run: |
          # NOTE: In a real setup, this step would download the pre-built
          # libwebrtc.a artifact from the webrtc-rockchip-mpp repository.
          #
          # For now, we create a placeholder directory structure so the build
          # system can find the expected paths. The actual library must be
          # provided via a release artifact or a separate build step.
          #
          # To use a real artifact, replace this block with:
          #   gh release download --repo user/webrtc-rockchip-mpp \
          #     --pattern 'webrtc-mpp-aarch64-*.tar.gz' --dir /tmp
          #   tar xzf /tmp/webrtc-mpp-aarch64-*.tar.gz -C /tmp/webrtc-artifacts
          #   echo "WEBRTC_DIR=/tmp/webrtc-artifacts" >> "$GITHUB_OUTPUT"

          mkdir -p /tmp/webrtc-artifacts/lib /tmp/webrtc-artifacts/include
          echo "WEBRTC_DIR=/tmp/webrtc-artifacts" >> "$GITHUB_OUTPUT"
          echo "::warning::Using placeholder libwebrtc.a -- link step will fail without real artifact"

      - name: Configure Cargo for cross compilation
        run: |
          mkdir -p /tmp/rust-sdks/.cargo
          cat > /tmp/rust-sdks/.cargo/config.toml <<'TOML'
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"

          [env]
          PKG_CONFIG_ALLOW_CROSS = "1"
          TOML

      - name: Cross-compile webrtc-sys
        continue-on-error: true
        env:
          LK_CUSTOM_WEBRTC: ${{ steps.webrtc.outputs.WEBRTC_DIR }}
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
          AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
          PKG_CONFIG_aarch64_unknown_linux_gnu: /tmp/aarch64-pkg-config
        working-directory: /tmp/rust-sdks
        run: |
          cargo build \
            --target aarch64-unknown-linux-gnu \
            -p webrtc-sys \
            2>&1 | tail -100

      - name: Verify Rockchip symbols (if build succeeded)
        continue-on-error: true
        run: |
          BINARY_DIR="/tmp/rust-sdks/target/aarch64-unknown-linux-gnu/debug"
          if [ -d "$BINARY_DIR" ]; then
            echo "Checking for Rockchip symbols in build output..."
            find "$BINARY_DIR" -name '*.o' -o -name '*.a' 2>/dev/null | head -20
            # Look for Rockchip factory symbols
            find "$BINARY_DIR" -name '*.o' -exec \
              aarch64-linux-gnu-nm {} \; 2>/dev/null \
              | grep -i rockchip || echo "No Rockchip symbols found (expected if using placeholder libwebrtc.a)"
          else
            echo "Build directory not found -- build likely failed (expected without real libwebrtc.a)"
          fi
