name: Check LiveKit SDK Compatibility

on:
  workflow_dispatch:

env:
  COMPAT_ISSUE_TITLE: "Upstream LiveKit SDK compatibility issue"
  COMPAT_ISSUE_LABEL: "upstream-compat"

jobs:
  check:
    name: Test patches against latest upstream
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone latest LiveKit rust-sdks (main branch)
        run: |
          git clone --depth=1 https://github.com/livekit/rust-sdks.git /tmp/rust-sdks
          cd /tmp/rust-sdks
          UPSTREAM_COMMIT="$(git rev-parse --short HEAD)"
          UPSTREAM_DATE="$(git log -1 --format=%ci)"
          echo "UPSTREAM_COMMIT=$UPSTREAM_COMMIT" >> "$GITHUB_ENV"
          echo "UPSTREAM_DATE=$UPSTREAM_DATE" >> "$GITHUB_ENV"
          echo "Upstream SDK at: $UPSTREAM_COMMIT ($UPSTREAM_DATE)"

      - name: Test patch application (dry-run)
        id: patch_check
        run: |
          chmod +x ./apply_patches.sh
          set +e
          OUTPUT=$(./apply_patches.sh --dry-run /tmp/rust-sdks 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"
          echo "PATCH_EXIT_CODE=$EXIT_CODE" >> "$GITHUB_ENV"
          echo "PATCH_OUTPUT<<PATCH_EOF" >> "$GITHUB_ENV"
          echo "$OUTPUT" >> "$GITHUB_ENV"
          echo "PATCH_EOF" >> "$GITHUB_ENV"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "result=success" >> "$GITHUB_OUTPUT"
            echo "All patches apply cleanly to upstream main."
          else
            echo "result=failure" >> "$GITHUB_OUTPUT"
            echo "::error::Patches do not apply cleanly to upstream main."
          fi

      - name: Show upstream changes in patched files
        if: steps.patch_check.outputs.result == 'failure'
        run: |
          cd /tmp/rust-sdks
          echo "=== Recent changes to build.rs ==="
          git log --oneline -10 -- webrtc-sys/build.rs || true
          echo ""
          echo "=== Recent changes to video_encoder_factory.cpp ==="
          git log --oneline -10 -- webrtc-sys/src/video_encoder_factory.cpp || true
          echo ""
          echo "=== Recent changes to video_decoder_factory.cpp ==="
          git log --oneline -10 -- webrtc-sys/src/video_decoder_factory.cpp || true

      - name: Create or update issue on failure
        if: steps.patch_check.outputs.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = process.env.COMPAT_ISSUE_TITLE;
            const label = process.env.COMPAT_ISSUE_LABEL;
            const upstreamCommit = process.env.UPSTREAM_COMMIT;
            const upstreamDate = process.env.UPSTREAM_DATE;
            const patchOutput = process.env.PATCH_OUTPUT;

            // Ensure the label exists
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: 'e11d48',
                  description: 'Patches no longer apply to upstream LiveKit SDK',
                });
              }
            }

            const body = [
              `## Patch Compatibility Failure`,
              ``,
              `The Rockchip MPP patches no longer apply cleanly to the latest LiveKit rust-sdks main branch.`,
              ``,
              `**Upstream commit:** \`${upstreamCommit}\``,
              `**Upstream date:** ${upstreamDate}`,
              `**Checked:** ${new Date().toISOString()}`,
              ``,
              `### Patch output`,
              `\`\`\``,
              patchOutput,
              `\`\`\``,
              ``,
              `### Resolution`,
              ``,
              `See [docs/PATCHING_GUIDE.md](docs/PATCHING_GUIDE.md) for instructions on updating the patches.`,
              ``,
              `1. Check what changed in the upstream files`,
              `2. Manually reapply the small changes (8-10 lines each)`,
              `3. Regenerate the patch files`,
              `4. Update [docs/SUPPORTED_VERSIONS.md](docs/SUPPORTED_VERSIONS.md) with the new commit`,
            ].join('\n');

            // Find existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: 'open',
            });

            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body,
              });
              console.log(`Updated existing issue #${issues[0].number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: [label],
              });
              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Close compatibility issue on success
        if: steps.patch_check.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const label = process.env.COMPAT_ISSUE_LABEL;
            const upstreamCommit = process.env.UPSTREAM_COMMIT;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: 'open',
            });

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Patches apply cleanly again as of upstream commit \`${upstreamCommit}\`. Closing.`,
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
              console.log(`Closed issue #${issue.number}`);
            }
